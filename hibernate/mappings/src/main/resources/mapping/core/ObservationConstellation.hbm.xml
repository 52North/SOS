<?xml version="1.0"?>
<!DOCTYPE hibernate-mapping PUBLIC "-//Hibernate/Hibernate Mapping DTD 3.0//EN"
    "http://www.hibernate.org/dtd/hibernate-mapping-3.0.dtd">
<hibernate-mapping>
    <class name="org.n52.sos.ds.hibernate.entities.ObservationConstellation">
        <subselect>
            SELECT
                @observationConstellationId := @observationConstellationId + 1 AS observationconstellationid,
                                                                                  observableProperty,
                                                                                  `procedure`,
                                                                                  offering
            FROM
                (
                    SELECT DISTINCT
                        procedure_ids.procedureId                   AS `procedure`,
                        observableProperty_ids.observablePropertyId AS observableProperty,
                        offering_ids.offeringId                     AS offering
                    FROM
                        (
                            SELECT
                                table_name  AS offering,
                                table_name  AS `procedure`,
                                column_name AS observableProperty
                            FROM
                                information_schema.columns
                            WHERE
                                table_schema = (SELECT DATABASE())
                                AND
                                data_type = 'double'
                            ORDER BY
                                table_name
                        ) AS combinations
                        JOIN
                        (
                            SELECT
                                 @observationConstellationProcedureId := @observationConstellationProcedureId+1 AS procedureId,
                                table_name                                                                      AS identifier
                             FROM
                                (
                                    SELECT
                                       table_name
                                    FROM
                                        information_schema.tables
                                    WHERE
                                        table_schema = (SELECT DATABASE())
                                    ORDER BY
                                        table_name
                                ) AS t1,
                                (
                                    SELECT @observationConstellationProcedureId := 0
                                ) AS t2
                        ) AS procedure_ids
                        ON
                            combinations.procedure = procedure_ids.identifier
                        JOIN
                        (
                            SELECT
                                @observationConstellationObservablePropertyId := @observationConstellationObservablePropertyId + 1 AS observablePropertyId,
                                column_name                                                                                        AS identifier
                            FROM (
                               SELECT DISTINCT
                                    column_name
                               FROM
                                    information_schema.columns
                               WHERE
                                    table_schema = (SELECT DATABASE())
                                    AND
                                    data_type = 'double'
                               ORDER BY
                                    column_name
                            ) AS t1,
                            (
                                SELECT
                                    @observationConstellationObservablePropertyId := 0
                            ) AS t2
                        ) AS observableProperty_ids
                        ON
                            combinations.observableProperty = observableProperty_ids.identifier
                        JOIN
                        (
                            SELECT
                                @observationConstellationOfferingId := @observationConstellationOfferingId + 1 AS offeringId,
                                table_name                                                                     AS identifier
                            FROM (
                                SELECT
                                    table_name
                                FROM
                                    information_schema.tables
                                WHERE
                                    table_schema = (SELECT DATABASE())
                                ORDER BY
                                    table_name
                            ) AS t1,
                            (
                                SELECT
                                    @observationConstellationOfferingId := 0
                            ) AS t2
                        ) AS offering_ids
                        ON
                            combinations.offering = offering_ids.identifier
                    ORDER BY
                        `procedure`,
                        observableProperty
            ) AS t1,
            (
                SELECT
                    @observationConstellationId := 0
            ) AS t2
        </subselect>
        <id name="observationConstellationId" type="long" />
        <many-to-one name="observableProperty" class="org.n52.sos.ds.hibernate.entities.ObservableProperty" fetch="select" lazy="no-proxy" insert="false" update="false" />
        <many-to-one name="procedure" class="org.n52.sos.ds.hibernate.entities.Procedure" fetch="select" lazy="no-proxy" insert="false" update="false" />
        <many-to-one name="observationType" class="org.n52.sos.ds.hibernate.entities.ObservationType" fetch="select" lazy="no-proxy" insert="false" update="false" formula="1" />
        <many-to-one name="offering" class="org.n52.sos.ds.hibernate.entities.Offering" fetch="select" lazy="no-proxy" insert="false" update="false" />
        <property name="deleted" type="org.hibernate.type.TrueFalseType" insert="false" update="false"  formula="'F'"/>
        <property name="hiddenChild" type="org.hibernate.type.TrueFalseType" insert="false" update="false" formula="'F'"/>
    </class>
</hibernate-mapping>
