/*
 * Copyright (C) 2012-2016 52Â°North Initiative for Geospatial Open Source
 * Software GmbH
 *
 * This program is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 as published
 * by the Free Software Foundation.
 *
 * If the program is linked with libraries which are licensed under one of
 * the following licenses, the combination of the program with the linked
 * library is not considered a "derivative work" of the program:
 *
 *     - Apache License, version 2.0
 *     - Apache Software License, version 1.0
 *     - GNU Lesser General Public License, version 3
 *     - Mozilla Public License, versions 1.0, 1.1 and 2.0
 *     - Common Development and Distribution License (CDDL), version 1.0
 *
 * Therefore the distribution of the program linked with libraries licensed
 * under the aforementioned licenses, is permitted by the copyright holders
 * if the distribution is compliant with both the GNU General Public
 * License version 2 and the aforementioned licenses.
 *
 * This program is distributed in the hope that it will be useful, but
 * WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General
 * Public License for more details.
 */
/*! client 2016-10-07 14:27 */
function fetchData(){var a=angular.injector(["ng"]),b=a.get("$http");return b.get("settings.json").then(function(a){mainApp.constant("config",a.data)})}function bootstrapApp(){angular.element(document).ready(function(){var a=angular.bootstrap(document,["jsClient"],{strictDi:!0}),b=a.get("startupService");b.registerServices(["SetTimeseriesOfStatusService","SetTimeParameterService","SetInternalTimeseriesService","SetConstellationService","SetConstellationServiceHack","SetLanguageService"]),b.checkServices(),a.get("mapService")})}var mainApp=angular.module("jsClient",["ngRoute","ui.bootstrap","ui-notification","LocalStorageModule","ui-leaflet","pascalprecht.translate","ngSanitize","ngTable","ngResource","n52.core.alert","n52.core.barChart","n52.core.color","n52.core.dataLoading","n52.core.diagram","n52.core.exportTs","n52.core.favorite","n52.core.favoriteUi","n52.core.flot","n52.core.helper","n52.core.interface","n52.core.legend","n52.core.listSelection","n52.core.locate","n52.core.map","n52.core.menu","n52.core.userSettings","n52.core.legend","n52.core.table","n52.core.exportTs","n52.core.timeUi","n52.core.metadata","n52.core.modal","n52.core.overviewDiagram","n52.core.permalinkEval","n52.core.permalinkGen","n52.core.phenomena","n52.core.provider","n52.core.rawDataOutput","n52.core.userSettings","n52.core.settings","n52.core.sosMetadata","n52.core.startup","n52.core.status","n52.core.style","n52.core.styleTs","n52.core.table","n52.core.time","n52.core.timeUi","n52.core.timeseries","n52.core.tooltip","n52.core.translateSelector","n52.core.utils","n52.core.yAxisHide","n52.client.navigation","n52.client.map","n52.client.mobile"]);mainApp.config(["$routeProvider",function(a){a.when("/",{templateUrl:"templates/views/diagramView.html",reloadOnSearch:!1}).when("/diagram",{templateUrl:"templates/views/diagramView.html",name:"navigation.diagram",reloadOnSearch:!1}).when("/map",{templateUrl:"templates/views/mapView.html",name:"navigation.map",reloadOnSearch:!1}).when("/mobileDiagram",{templateUrl:"templates/views/combiView.html",name:"navigation.trajectories",reloadOnSearch:!1}).when("/favorite",{templateUrl:"templates/views/favoriteView.html",name:"navigation.favorite",reloadOnSearch:!1}).when("/map/provider",{name:"navigation.provider",modal:{controller:"SwcProviderListModalCtrl",templateUrl:"templates/map/provider-list-modal.html"},reloadOnSearch:!1}).when("/diagram/listSelection",{name:"navigation.listSelection",modal:{controller:"ModalWindowCtrl",templateUrl:"templates/listSelection/modal-list-selection.html"},reloadOnSearch:!1}).when("/diagram/settings",{name:"navigation.settings",modal:{controller:"SwcUserSettingsWindowCtrl",templateUrl:"templates/settings/user-settings-modal.html"},reloadOnSearch:!1}).otherwise({redirectTo:"/"})}]),mainApp.config(["$translateProvider","settingsServiceProvider",function(a,b){a.useStaticFilesLoader({prefix:"i18n/",suffix:".json"});var c=[];angular.forEach(b.$get().supportedLanguages,function(a){c.push(a.code)}),a.registerAvailableLanguageKeys(c),a.determinePreferredLanguage(),""!==a.preferredLanguage()&&c.indexOf(a.preferredLanguage())!==-1||a.preferredLanguage("en"),a.useSanitizeValueStrategy("sanitize")}]),mainApp.filter("objectCount",function(){return function(a){return a?Object.keys(a).length:0}}),mainApp.config(["$provide",function(a){a.decorator("$log",["$delegate",function(a){var b=a.debug;return a.info=function(){var a=[].slice.call(arguments),c=moment().format("HH:mm:ss.SSS");a[0]=c+" - "+a[0],b.apply(null,a)},a}])}]),fetchData().then(bootstrapApp),angular.module("n52.client.map",[]).controller("LayerControlCtrl",["$scope",function(a){angular.extend(a,{layercontrol:{icons:{uncheck:"glyphicon glyphicon-unchecked",check:"glyphicon glyphicon-check",radio:"glyphicon glyphicon-check",unradio:"glyphicon glyphicon-unchecked"}}})}]).controller("ToDiagramCtrl",["$scope","$location",function(a,b){a.toDiagram=function(){b.url("/diagram")}}]),angular.module("n52.client.navigation",[]).factory("routeNavigation",["$route","$location",function(a,b){var c=[];return angular.forEach(a.routes,function(a,b){a.name&&c.push({path:b,name:a.name,modal:a.modal})}),{routes:c,activeRoute:function(a){return a.path===b.path()}}}]).directive("navigation",["routeNavigation",function(a){return{restrict:"E",replace:!0,templateUrl:"templates/menu/navigation.html",controller:["$scope","$location","$uibModal",function(b,c,d){b.routes=a.routes,b.activeRoute=a.activeRoute,b.open=function(a){a&&(c.url(c.url()),d.open({animation:!0,templateUrl:a.templateUrl,controller:a.controller}))}}]}}]).config(["$provide",function(a){a.decorator("providerService",["$delegate","$location",function(a,b){var c=a.selectProvider;return a.selectProvider=function(a){c(a),b.url("/map")},a}])}]),angular.module("n52.client.mobile",[]).directive("swcCombiMobile",[function(){return{restrict:"E",templateUrl:"templates/mobile/combi-mobile.html",replace:!0,controller:["$scope","combinedSrvc","leafletData",function(a,b,c){function d(){i&&(i.remove(),j.remove(),g.remove(),h.remove(),i=void 0)}function e(b){c.getMap("mobileCombiMap").then(function(c){var d=c.latLngToLayerPoint(b.latlng);if(!i){var e=d3.select(".leaflet-overlay-pane svg").append("g");i=e.append("g"),i.append("svg:circle").attr("r",6).attr("cx",0).attr("cy",0).attr("class","height-focus circle-lower"),j=e.append("svg:rect").attr("class","map-highlight-label"),g=e.append("svg:text").attr("class","focus-label").style("pointer-events","none"),h=e.append("svg:text").attr("class","focus-label").style("pointer-events","none")}i.attr("transform","translate("+d.x+","+d.y+")").style("visibility","visible"),g.attr("x",d.x+10).attr("y",d.y).text(b.value+a.series.uom).style("visibility","visible"),h.attr("x",d.x+10).attr("y",d.y+13).text(moment(b.timestamp).format("DD.MM.YY HH:mm")).style("visibility","visible"),j.attr("x",d.x+8).attr("y",d.y-11).attr("width",100).attr("height",28)})}function f(){j&&(h.style("visibility","hidden"),g.style("visibility","hidden"),j.style("visibility","hidden")),i&&i.style("visibility","hidden")}var g,h,i,j;a.events={geometry:{enable:["mouseover"]}},a.geometry=b.geometry,a.series=b.series,a.highlight=b.highlight,a.selectedSection=b.selectedSection,a.paths={section:{color:"blue",weight:4,latlngs:[]}},a.$watch("geometry",function(a){a&&a.data&&a.data.coordinates.length>0&&(k(),d())},!0),a.$watch("highlight",function(a){a.latlng?e(a):f()},!0),a.$on("leafletDirectiveMap.mobileCombiMap.zoomend",function(b){void 0!==a.highlight.latlng&&e(a.highlight)}),a.$watchCollection("selectedSection",function(b){if(b&&b.values&&b.values.length>0){a.paths.section.latlngs=[];var d=[];angular.forEach(b.values,function(b){a.paths.section.latlngs.push({lat:b.latlng.lat,lng:b.latlng.lng}),d.push(b.latlng)}),c.getMap("mobileCombiMap").then(function(a){a.fitBounds(d)})}else k(),a.paths.section.latlngs=[]},!0),a.$on("leafletDirectiveGeoJson.mobileCombiMap.mouseover",function(a,c){c&&c.leafletEvent&&c.leafletEvent.latlng&&b.showHighlightedItem(c.leafletEvent.latlng)});var k=function(){a.geometry&&a.geometry.data.coordinates.length>0&&c.getMap("mobileCombiMap").then(function(b){var c=[];angular.forEach(a.geometry.data.coordinates,function(a){c.push(L.GeoJSON.coordsToLatLng(a))}),b.fitBounds(c)})}}]}}]).directive("d3LinearChart",["$window","combinedSrvc",function(a,b){return{restrict:"EA",link:function(c,d,e){function f(){return P.height()-M.top-M.bottom}function g(){return P.width()-M.left-M.right}function h(){w=O.scale.linear().domain([c.data.values[0].dist,c.data.values[c.data.values.length-1].dist]).range([0,g()]);var a=c.data.range.max-c.data.range.min,b=.05*a;x=O.scale.linear().domain([c.data.range.min-b,c.data.range.max+b]).range([f(),0]),y=O.svg.axis().scale(w).orient("bottom").ticks(10),z=O.svg.axis().scale(x).orient("left").ticks(5),A=O.svg.line().x(function(a){var b=w(a.dist);return a.xDiagCoord=b,b}).y(function(a){return x(a.value)}).interpolate("linear"),B=O.svg.area().x(function(a){var b=w(a.dist);return a.xDiagCoord=b,b}).y0(f()).y1(function(a){return x(a.value)}).interpolate("linear")}function i(){return O.svg.axis().scale(w).orient("bottom").ticks(10)}function j(){return O.svg.axis().scale(x).orient("left").ticks(5)}function k(){R.selectAll("*").remove(),h(),R.append("svg:g").attr("class","grid").attr("transform","translate(0,"+f()+")").call(i().tickSize(-f(),0,0).tickFormat("")),R.append("text").attr("x",g()/2).attr("y",f()+M.bottom-5).style("text-anchor","middle").text("Distance"),R.append("svg:g").attr("class","grid").call(j().tickSize(-g(),0,0).tickFormat("")),R.append("text").attr("transform","rotate(-90)").attr("y",0-M.left).attr("x",0-f()/2).attr("dy","1em").style("text-anchor","middle").text(c.series.uom),R.append("svg:path").datum(c.data.values).attr({d:B,class:"graphArea"}),R.append("svg:g").attr("class","x axis").attr("transform","translate(0,"+f()+")").call(y),R.append("svg:g").attr("class","x axis").call(O.svg.axis().scale(w).orient("top").tickSize(0).tickFormat("")),R.append("svg:g").attr("class","y axis").call(z),R.append("svg:g").attr("class","y axis").attr("transform","translate("+g()+", 0)").call(O.svg.axis().scale(x).orient("right").tickSize(0).tickFormat("")),R.append("svg:path").attr({d:A(c.data.values),stroke:"blue","stroke-width":2,fill:"none",class:N}),v=R.append("svg:rect").attr({width:g(),height:f(),fill:"none",stroke:"none","pointer-events":"all"}).on("mousemove.focus",l).on("mouseout.focus",m).on("mousedown.drag",n).on("mousemove.drag",o).on("mouseup.drag",p),C=R.append("g"),D=C.append("svg:line").attr("class","mouse-focus-line").attr("x2","0").attr("y2","0").attr("x1","0").attr("y1","0"),E=C.append("svg:text").style("pointer-events","none").attr("class","mouse-focus-label-x"),F=C.append("svg:text").style("pointer-events","none").attr("class","mouse-focus-label-x"),G=C.append("svg:text").style("pointer-events","none").attr("class","mouse-focus-label-y")}function l(a,d,e){if(c.data.values&&0!==c.data.values.length){var f=O.mouse(v.node());b.highlightByIdx(s(f[0])),c.$apply()}}function m(){t()}function n(){O.event.preventDefault(),O.event.stopPropagation(),H=!1,I=O.mouse(v.node())}function o(){O.event.preventDefault(),O.event.stopPropagation(),H=!0,q()}function p(){I&&H?(b.setSelection(s(I[0]),s(J[0])),I=null,H=!1):(I=null,H=!1,r()),c.$apply()}function q(){if(I){J=O.mouse(v.node());var a=Math.min(I[0],J[0]),b=Math.max(I[0],J[0]);K||L?K.attr("width",b-a).attr("x",a):(L=R.append("g"),K=L.append("rect").attr("width",b-a).attr("height",f()).attr("x",a).attr("class","mouse-drag").style("pointer-events","none"))}}function r(){b.resetSelection(),null!==L&&(L.remove(),L=null,K=null)}function s(a){var b=O.bisector(function(a){return a.dist}).left,d=w.invert(a);return b(c.data.values,d)}function t(){C.style("visibility","hidden")}function u(a,b){C.style("visibility","visible"),D.attr("x1",b).attr("y1",0).attr("x2",b).attr("y2",f()).classed("hidden",!1);var d=a.value,e=a.dist,g=d,h=e;E.attr("x",b+2).attr("y",13).text(g+c.series.uom),F.attr("x",b-95).attr("y",13).text(moment(a.timestamp).format("DD.MM.YY HH:mm")),G.attr("y",f()-5).attr("x",b+2).text(h+" km")}c.data=b.data,c.series=b.series,c.highlight=b.highlight;var v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M={top:10,right:20,bottom:40,left:40},N="path",O=a.d3;O.select(d[0]).append("svg").attr("width","100%").attr("height","100%");var P=d.find("svg"),Q=O.select(P[0]),R=Q.append("g").attr("transform","translate("+M.left+","+M.top+")");c.$watchCollection("data",function(){c.data.values.length>0&&k()}),c.$watchCollection("highlight",function(){c.highlight.xDiagCoord&&u(c.highlight,c.highlight.xDiagCoord)}),angular.element(a).bind("resize",function(){k()})}}}]).service("combinedSrvc",["interfaceService","statusService",function(a,b){if(this.highlight={},this.selectedSection={values:[]},this.geometry={style:{weight:2,opacity:1,color:"red",dashArray:"10, 5",clickable:!0},data:{coordinates:[],type:"LineString"}},this.data={values:[],range:{max:0,min:1/0},dist:0},this.series={},this.loadSeries=function(c,d){var e=this;b.status.mobile={id:c,url:d},this.series.loading=!0,a.getDatasets(c,d).then(function(b){angular.extend(e.series,b);var f={start:b.firstValue.timestamp,end:b.lastValue.timestamp};a.getDatasetData(b.id,d,f,{expanded:!0}).then(function(a){e.processData(a[c].values),e.series.loading=!1})})},this.processData=function(a){this.resetGeometry(),this.resetData();for(var b=0;b<a.length;b++)this.addToGeometry(a[b]),this.addToData(a[b],a[b?b-1:0])},this.addToGeometry=function(a){this.geometry.data.coordinates.push(a.geometry.coordinates)},this.addToData=function(a,b){var c=new L.LatLng(a.geometry.coordinates[1],a.geometry.coordinates[0]),d=new L.LatLng(b.geometry.coordinates[1],b.geometry.coordinates[0]),e=c.distanceTo(d);this.data.dist=this.data.dist+Math.round(e/1e3*1e5)/1e5,this.data.range.max=this.data.range.max<a.value?a.value:this.data.range.max,this.data.range.min=this.data.range.min>a.value?a.value:this.data.range.min,this.data.values.push({dist:Math.round(10*this.data.dist)/10,timestamp:a.timestamp,value:a.value,x:a.geometry.coordinates[0],y:a.geometry.coordinates[1],latlng:c})},this.resetGeometry=function(){this.geometry.data.coordinates=[]},this.resetData=function(){this.data.values=[],this.data.dist=0,this.data.range.max=0,this.data.range.min=1/0},this.findItemForLatLng=function(a){var b=null,c=1/0;return angular.forEach(this.data.values,function(d){var e=a.distanceTo(d.latlng);e<c&&(c=e,b=d)}),b},this.highlightByIdx=function(a){angular.extend(this.highlight,this.data.values[a])},this.showHighlightedItem=function(a){angular.extend(this.highlight,this.findItemForLatLng(a))},this.setSelection=function(a,b){var c=Math.min(a,b),d=Math.max(a,b);this.selectedSection.values=this.data.values.slice(c,d)},this.resetSelection=function(){this.selectedSection.values=[]},b.status.mobile){var c=b.status.mobile;c.id&&c.url&&this.loadSeries(c.id,c.url)}}]).service("mobilePresentDataset",["$location","combinedSrvc",function(a,b){this.presentDataset=function(c,d){b.loadSeries(c.id,d),a.url("/mobileDiagram")}}]),angular.module("n52.client.mobile").controller("ListSelectionMobileButtonCtrl",["$scope","$uibModal","combinedSrvc",function(a,b,c){a.openListSelectionMobile=function(){b.open({animation:!0,templateUrl:"templates/mobile/modal-list-selection-mobile.html",controller:"ModalListSelectionMobileCtrl"})},0===Object.keys(c.series).length&&a.openListSelectionMobile()}]).controller("ModalListSelectionMobileCtrl",["$scope","$uibModalInstance",function(a,b){a.modalInstance=b,a.platformParams=[{type:"platform",header:"trajectories.headers.platform"},{type:"features",header:"trajectories.headers.track"},{type:"phenomenon",header:"trajectories.headers.phenomenon"},{type:"dataset",header:"trajectories.headers.dataset"}],a.phenomenonParams=[{type:"phenomenon",header:"trajectories.headers.phenomenon"},{type:"features",header:"trajectories.headers.track"},{type:"dataset",header:"trajectories.headers.dataset"}],a.close=function(){b.close()}}]).controller("SwcProviderListCtrl",["$scope","providerService",function(a,b){a.providerselected=null,a.providerList=b.getAllProviders(),a.selectProvider=function(b){a.providerselected=b}}]).directive("swcListSelectionMobile",[function(){return{restrict:"E",templateUrl:"templates/listSelection/list-selection.html",scope:{parameters:"=",provider:"="},controller:"ListSelectionMobileCtrl"}}]).controller("ListSelectionMobileCtrl",["$scope","interfaceService","combinedSrvc",function(a,b,c){var d=a.provider.url;angular.forEach(a.parameters,function(b,c){a.$watch("parameters["+c+"].isOpen",function(b,d){b&&(a.selectedParameterIndex=c,angular.forEach(a.parameters,function(a,b){b>c&&(a.isDisabled=!0,delete a.selectedId,delete a.items),b>=c&&delete a.headerAddition}))})}),a.createParams=function(){var b={};return angular.forEach(a.parameters,function(a){a.selectedId&&(b[a.type]=a.selectedId)}),b},a.getItems=function(c){c.loading=1,"platform"===c.type?b.getMobilePlatforms(null,d,a.createParams()).then(function(a){updateParams(c,a)}).catch(errorOnGetData):"features"===c.type?b.getFeatures(null,d,a.createParams()).then(function(a){updateParams(c,a)}).catch(errorOnGetData):"phenomenon"===c.type?b.getPhenomena(null,d,a.createParams()).then(function(a){updateParams(c,a)}).catch(errorOnGetData):"dataset"===c.type&&b.getDatasets(null,d,a.createParams()).then(function(a){updateParams(c,a)}).catch(errorOnGetData)},updateParams=function(a,b){a.items=b,a.loading--},errorOnGetData=function(){currParam.error=!0},a.openNext=function(b){a.parameters[b].isDisabled=!1,a.selectedParameterIndex=b,a.parameters[b].isOpen=!0,a.getItems(a.parameters[b])},a.openItem=function(b){a.parameters[a.selectedParameterIndex].selectedId=b.id,a.parameters[a.selectedParameterIndex].headerAddition=b.label,a.selectedParameterIndex<a.parameters.length-1?a.openNext(a.selectedParameterIndex+1):(c.loadSeries(b.id,d),a.$parent.modalInstance.close())},a.openNext(0)}]);