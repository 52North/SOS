<?xml version="1.0"?>
<!DOCTYPE hibernate-mapping PUBLIC "-//Hibernate/Hibernate Mapping DTD 3.0//EN"
    "http://www.hibernate.org/dtd/hibernate-mapping-3.0.dtd">
<hibernate-mapping>
    <class name="org.n52.sos.ds.hibernate.entities.series.Series" table="Observation">
        <id name="seriesId" type="long">
            <column name="Id" />
            <generator class="assigned">
            </generator>
        </id>
        <!-- 
			The User Guide defines the AQD_Sample (inlet) as featureOfInterest.
			But the DB-Dump does not contain data in the inlet table.
	 	-->
        <many-to-one name="featureOfInterest" class="org.n52.sos.ds.hibernate.entities.FeatureOfInterest" fetch="select" lazy="no-proxy" foreign-key="seriesFeatureFk">
           	<formula>(SELECT DISTINCT sta.Id FROM AQD.dbo.Station sta, AQD.dbo.SamplingPoint spo, AQD.dbo.Observation o where sta.Id = spo.stationId AND spo.Id = o.samplingPointId AND o.Id = Id)</formula>
           	<!-- <column index="seriesFeatureIdx" name="feature_of_interest_pkid" not-null="true" unique-key="seriesIdentity" /> -->
        </many-to-one>
        <many-to-one name="observableProperty" class="org.n52.sos.ds.hibernate.entities.ObservableProperty" fetch="select" lazy="no-proxy" foreign-key="seriesObPropFk">
            <column index="seriesObsPropIdx" name="pollutantId" not-null="true" unique-key="seriesIdentity"/>
        </many-to-one>
        <many-to-one name="procedure" class="org.n52.sos.ds.hibernate.entities.Procedure" fetch="select" lazy="no-proxy" foreign-key="seriesProcedureFk">
            <column index="seriesProcedureIdx" name="processId" not-null="true" unique-key="seriesIdentity" />
        </many-to-one>
        <property name="deleted" type="org.hibernate.type.TrueFalseType">
            <formula>'F'</formula>
        </property>
    </class>
    
    <sql-query name="getUnitForObservablePropertyProcedureSeries">
		<return-scalar column="unit" type="string"/>
		SELECT DISTINCT r.unit
		FROM AQD.dbo.Result r
		inner join AQD.dbo.Observation o on r.observationId=o.Id
		inner join AQD.dbo.Pollutant poll on o.pollutantId=poll.Id
		inner join AQD.dbo.SPProcess pro on o.processId=pro.Id
		WHERE poll.URI = :observableProperty AND pro.inspireId = :procedure
	</sql-query>
</hibernate-mapping>
